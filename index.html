<!DOCTYPE html>
<html lang="id" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>OCS NFI Daily Report - Speed Optimized</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Roboto', sans-serif;
            -webkit-tap-highlight-color: transparent;
            overscroll-behavior-y: contain;
            height: 100%;
            width: 100%;
        }
        .m3-card {
            background-color: #1c1b1f; 
            border-radius: 24px;
        }
        .m3-input {
            background-color: #2b2930;
            border-bottom: 2px solid #938f99;
            border-radius: 4px 4px 0 0;
            font-size: 16px !important; 
        }
        .image-card {
            aspect-ratio: 1/1;
            border-radius: 12px;
            overflow: hidden;
            position: relative;
            background-color: #2b2930;
        }
        .image-card img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        #loadingOverlay {
            display: none;
            background-color: rgba(20, 18, 24, 0.9);
            backdrop-filter: blur(8px);
        }
        .photo-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            gap: 8px;
        }
        @media (min-width: 480px) {
            .photo-grid {
                grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
                gap: 12px;
            }
        }
        .fab-button {
            position: fixed;
            bottom: 24px;
            right: 24px;
            width: 64px;
            height: 64px;
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #d0bcff;
            color: #381e72;
            z-index: 50;
            transition: transform 0.2s;
        }
        .fab-hide { transform: scale(0); opacity: 0; pointer-events: none; }
    </style>
</head>
<body class="bg-[#141218] text-[#e6e1e5] min-h-screen flex flex-col">

    <header class="sticky top-0 z-30 bg-[#1c1b1f]/95 backdrop-blur-xl px-4 py-3 flex items-center justify-between border-b border-[#49454f]">
        <div class="flex flex-col">
            <h1 class="text-sm sm:text-lg font-medium tracking-tight">OCS NFI Daily Report</h1>
            <span class="text-[8px] text-[#d0bcff] font-bold uppercase tracking-widest">by Pohara Ayub</span>
        </div>
        <div class="bg-[#2b2930] px-3 py-1.5 rounded-full border border-[#49454f]">
            <select id="qualitySelect" class="bg-transparent text-xs text-[#d0bcff] font-bold outline-none">
                <option value="0.3">Draft (Cepat)</option>
                <option value="0.5" selected>Standar</option>
                <option value="0.7">HD (Lambat)</option>
            </select>
        </div>
    </header>

    <main class="flex-1 px-4 py-4 space-y-6 max-w-2xl mx-auto w-full pb-32">
        <section class="m3-card p-5 border border-[#49454f]/50 shadow-lg">
            <div class="grid grid-cols-2 gap-4">
                <div class="space-y-1">
                    <label class="text-[9px] text-[#938f99] uppercase font-bold">Tanggal</label>
                    <input type="date" id="globalJobDate" class="m3-input w-full px-2 py-2 text-sm text-[#e6e1e5]">
                </div>
                <div class="space-y-1">
                    <label class="text-[9px] text-[#938f99] uppercase font-bold">Shift</label>
                    <select id="globalJobShift" class="m3-input w-full px-2 py-2 text-sm text-[#e6e1e5]">
                        <option value="Shift 1">Shift 1</option>
                        <option value="Shift 2">Shift 2</option>
                        <option value="Shift 3">Shift 3</option>
                    </select>
                </div>
            </div>
        </section>

        <section class="m3-card p-5 border border-[#49454f]">
            <div class="space-y-4">
                <input type="text" id="tempJobName" placeholder="Nama Pekerjaan..." class="m3-input w-full px-4 py-3 text-sm">
                <div class="grid grid-cols-2 gap-4">
                    <input type="text" id="tempAreaName" placeholder="Area..." class="m3-input w-full px-4 py-3 text-sm">
                    <input type="text" id="tempMembers" placeholder="Member..." class="m3-input w-full px-4 py-3 text-sm">
                </div>
                <button id="addJobBtn" class="w-full bg-[#d0bcff] text-[#381e72] py-4 rounded-xl font-bold uppercase text-[10px] tracking-widest shadow-lg active:scale-95 transition-transform">
                    Tambah Grup Pekerjaan
                </button>
            </div>
        </section>

        <div id="jobsContainer" class="space-y-6"></div>

        <div id="emptyState" class="flex flex-col items-center py-12 text-[#49454f]">
            <svg class="w-12 h-12 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>
            <p class="text-xs uppercase tracking-widest">Siap menambahkan foto</p>
        </div>
    </main>

    <button id="downloadBtn" class="fab-button fab-hide shadow-2xl">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5"><path d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>
    </button>

    <input type="file" id="globalFileInput" class="hidden" accept="image/*" multiple>

    <div id="loadingOverlay" class="fixed inset-0 z-50 flex flex-col items-center justify-center text-center">
        <div class="w-10 h-10 border-4 border-[#d0bcff] border-t-transparent rounded-full animate-spin mb-4"></div>
        <h3 id="loadingText" class="text-[#e6e1e5] font-medium tracking-wide">Memproses Laporan...</h3>
    </div>

    <script>
        const { jsPDF } = window.jspdf;
        const jobsContainer = document.getElementById('jobsContainer');
        const emptyState = document.getElementById('emptyState');
        const downloadBtn = document.getElementById('downloadBtn');
        const addJobBtn = document.getElementById('addJobBtn');
        const globalFileInput = document.getElementById('globalFileInput');
        const loadingOverlay = document.getElementById('loadingOverlay');

        let jobs = [];
        let currentJobId = null;

        document.getElementById('globalJobDate').valueAsDate = new Date();

        function getIndonesianDay(dateStr) {
            const days = ['Minggu', 'Senin', 'Selasa', 'Rabu', 'Kamis', 'Jumat', 'Sabtu'];
            return days[new Date(dateStr).getDay()];
        }

        addJobBtn.onclick = () => {
            const name = document.getElementById('tempJobName').value.trim();
            if (!name) return;
            jobs.push({
                id: 'j-' + Date.now(),
                name,
                area: document.getElementById('tempAreaName').value.trim() || '-',
                members: document.getElementById('tempMembers').value.trim() || '-',
                images: []
            });
            document.getElementById('tempJobName').value = '';
            document.getElementById('tempAreaName').value = '';
            document.getElementById('tempMembers').value = '';
            render();
        };

        function render() {
            emptyState.style.display = jobs.length ? 'none' : 'flex';
            downloadBtn.classList.toggle('fab-hide', !jobs.some(j => j.images.length));
            
            jobsContainer.innerHTML = jobs.map(job => `
                <div class="m3-card overflow-hidden border border-[#49454f]/30">
                    <div class="p-4 bg-[#2b2930]/30 border-b border-[#49454f]/20 flex justify-between items-center">
                        <div>
                            <h3 class="font-bold text-[#d0bcff] text-xs sm:text-sm uppercase">${job.name}</h3>
                            <p class="text-[9px] text-[#938f99] uppercase tracking-tight">${job.area} | Member: ${job.members}</p>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="upload('${job.id}')" class="p-2 text-[#d0bcff] bg-[#d0bcff]/10 rounded-full">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M12 4v16m8-8H4"/></svg>
                            </button>
                            <button onclick="delJob('${job.id}')" class="p-2 text-[#ffb4ab] bg-[#ffb4ab]/10 rounded-full">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
                            </button>
                        </div>
                    </div>
                    <div class="p-3 photo-grid">
                        ${job.images.map(img => `
                            <div class="image-card">
                                <img src="${img.src}">
                                <button onclick="delImg('${job.id}','${img.id}')" class="absolute top-1 right-1 bg-black/60 p-1 rounded-full text-[#ffb4ab]">
                                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M6 18L18 6M6 6l12 12"/></svg>
                                </button>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `).join('');
        }

        window.upload = (id) => { currentJobId = id; globalFileInput.click(); };
        window.delJob = (id) => { jobs = jobs.filter(j => j.id !== id); render(); };
        window.delImg = (jid, iid) => { 
            const j = jobs.find(x => x.id === jid);
            j.images = j.images.filter(img => img.id !== iid);
            render();
        };

        async function processImage(file, quality) {
            return new Promise((resolve) => {
                const img = new Image();
                const reader = new FileReader();
                reader.onload = (e) => img.src = e.target.result;
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const max = 1200;
                    let w = img.width, h = img.height;
                    if (w > h && w > max) { h *= max/w; w = max; }
                    else if (h > max) { w *= max/h; h = max; }
                    canvas.width = w; canvas.height = h;
                    canvas.getContext('2d').drawImage(img, 0, 0, w, h);
                    resolve({ 
                        id: Math.random().toString(36).substr(2, 9), 
                        src: canvas.toDataURL('image/jpeg', quality),
                        w: w, h: h
                    });
                };
                reader.readAsDataURL(file);
            });
        }

        globalFileInput.onchange = async (e) => {
            const files = Array.from(e.target.files);
            if (!files.length) return;
            
            loadingOverlay.style.display = 'flex';
            document.getElementById('loadingText').textContent = "Memproses Gambar...";
            
            const quality = parseFloat(document.getElementById('qualitySelect').value);
            const job = jobs.find(j => j.id === currentJobId);
            
            const processedImgs = await Promise.all(files.map(f => processImage(f, quality)));
            job.images.push(...processedImgs);
            
            loadingOverlay.style.display = 'none';
            render();
            globalFileInput.value = '';
        };

        downloadBtn.onclick = async () => {
            loadingOverlay.style.display = 'flex';
            document.getElementById('loadingText').textContent = "Menyusun Laporan PDF...";
            
            const pdf = new jsPDF('p', 'mm', 'a4', true);
            const dateInput = document.getElementById('globalJobDate').value;
            const shift = document.getElementById('globalJobShift').value;
            const dayName = getIndonesianDay(dateInput);
            
            const pw = pdf.internal.pageSize.getWidth();
            const ph = pdf.internal.pageSize.getHeight();
            const margin = 15;
            let first = true;

            for (const job of jobs) {
                if (!job.images.length) continue;
                
                for (let i = 0; i < job.images.length; i++) {
                    if (!first) pdf.addPage();
                    first = false;

                    let yPos = margin;
                    let availH = ph - (margin * 2);

                    if (i === 0) {
                        pdf.setTextColor(40);
                        pdf.setFontSize(18);
                        pdf.setFont('helvetica', 'bold');
                        const titleLines = pdf.splitTextToSize(job.name.toUpperCase(), pw - (margin * 2));
                        pdf.text(titleLines, margin, yPos + 5);
                        
                        const hTitle = (titleLines.length * 7);
                        pdf.setFontSize(9);
                        pdf.setFont('helvetica', 'normal');
                        pdf.text(`AREA: ${job.area.toUpperCase()} | MEMBER: ${job.members.toUpperCase()}`, margin, yPos + hTitle + 5);
                        pdf.text(`${dayName.toUpperCase()}, ${dateInput} | ${shift.toUpperCase()}`, margin, yPos + hTitle + 10);
                        
                        pdf.setDrawColor(200);
                        pdf.line(margin, yPos + hTitle + 13, pw - margin, yPos + hTitle + 13);
                        
                        yPos += hTitle + 20;
                        availH -= (hTitle + 20);
                    }

                    const img = job.images[i];
                    const scale = Math.min((pw - (margin * 2)) / img.w, availH / img.h);
                    const dw = img.w * scale;
                    const dh = img.h * scale;
                    const dx = (pw - dw) / 2;
                    const dy = yPos + (availH - dh) / 2;

                    pdf.addImage(img.src, 'JPEG', dx, dy, dw, dh, undefined, 'FAST');
                }
            }

            loadingOverlay.style.display = 'none';
            
            // Penamaan file otomatis: OCS NFI Daily Report [Hari] [Tanggal] [Shift]
            const fileName = `OCS NFI Daily Report ${dayName} ${dateInput} ${shift}.pdf`;
            pdf.save(fileName);
        };
    </script>
</body>
</html>

